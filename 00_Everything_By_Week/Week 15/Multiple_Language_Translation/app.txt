# streamlit_translation_ui.py
import streamlit as st
from mtranslate import translate
import pandas as pd
import os
from gtts import gTTS
import tempfile

# ---------- CONFIG ----------
st.set_page_config(
    page_title="Multi-Language Translator",
    layout="wide",
    initial_sidebar_state="expanded",
)




# ---------- Load language data ----------
# Update this path if your file is elsewhere
LANG_CSV_PATH = r'C:\Arman\FSDS GenAI 2025\Practicals\Projects\04_Natural_Language_Processing\Multiple_Language_Translation\language.csv'

@st.cache_data
def load_language_data(path):
    df = pd.read_csv(path)
    df.dropna(inplace=True)
    # name -> iso code
    names = df['name'].astype(str).tolist()
    codes = df['iso'].astype(str).tolist()
    name_to_code = {names[i]: codes[i] for i in range(len(names))}
    return names, codes, name_to_code

try:
    lang_names, lang_codes, lang_array = load_language_data(LANG_CSV_PATH)
except FileNotFoundError:
    st.error(f"Language CSV not found. Please update LANG_CSV_PATH in the script.\nCurrent: {LANG_CSV_PATH}")
    st.stop()

# Languages that gTTS supports (key = code). Keep your list or extend it.
speech_langs = {
    "af": "Afrikaans", "ar": "Arabic", "bg": "Bulgarian", "bn": "Bengali",
    "bs": "Bosnian", "ca": "Catalan", "cs": "Czech", "cy": "Welsh",
    "da": "Danish", "de": "German", "el": "Greek", "en": "English",
    "eo": "Esperanto", "es": "Spanish", "et": "Estonian", "fi": "Finnish",
    "fr": "French", "gu": "Gujarati", "hi": "Hindi", "hr": "Croatian",
    "hu": "Hungarian", "hy": "Armenian", "id": "Indonesian", "is": "Icelandic",
    "it": "Italian", "ja": "Japanese", "kn": "Kannada", "ko": "Korean",
    "la": "Latin", "lv": "Latvian", "mk": "Macedonian", "ml": "Malayalam",
    "mr": "Marathi", "ne": "Nepali", "nl": "Dutch", "no": "Norwegian",
    "pl": "Polish", "pt": "Portuguese", "ro": "Romanian", "ru": "Russian",
    "si": "Sinhala", "sk": "Slovak", "sq": "Albanian", "sr": "Serbian",
    "sv": "Swedish", "sw": "Swahili", "ta": "Tamil", "te": "Telugu",
    "th": "Thai", "tl": "Filipino", "tr": "Turkish", "uk": "Ukrainian",
    "ur": "Urdu", "vi": "Vietnamese", "zh-CN": "Chinese"
}

# ---------- Sidebar controls ----------
st.sidebar.header("Settings")
source_lang = st.sidebar.selectbox("Source language (for reference)", ["Auto-Detect", "English"] + lang_names, index=0)
target_lang = st.sidebar.selectbox("Target language", lang_names, index=lang_names.index("Hindi") if "Hindi" in lang_names else 0)
show_audio_option = st.sidebar.checkbox("Enable speech/audio for supported languages", value=True)
examples_expander = st.sidebar.expander("Examples")
with examples_expander:
    st.write("- 'The food was amazing and service excellent.'")
    st.write("- 'I waited too long and the staff was rude.'")
    st.write("- 'Loved the ambiance, will visit again.'")

# ---------- Header ----------
st.title("Multi-Language Translator")
st.markdown(
    "Enter text on the left, choose a target language from the sidebar, and click **Translate**. "
    "If available, you can also play and download the spoken audio of the translation."
)

# ---------- Main layout ----------
col_input, col_buttons, col_output = st.columns([3, 1, 3])

with col_input:
    st.subheader("Input")
    input_text = st.text_area("Type your text here...", height=180)
    # small quick actions
    c1, c2 = st.columns([1, 1])
    with c1:
        if st.button("Clear"):
            input_text = ""
            # must re-render; using session_state would be more persistent
            st.experimental_rerun()
    with c2:
        if st.button("Swap languages"):
            # swap source/target only if source selected from list
            # This is a UI convenience - not changing Auto-detect
            if source_lang != "Auto-Detect" and source_lang in lang_array:
                prev_target = target_lang
                target_lang = source_lang if source_lang != "Auto-Detect" else prev_target
                source_lang = prev_target
                st.experimental_rerun()

with col_buttons:
    st.subheader("Actions")
    translate_btn = st.button(" Translate")
    st.caption("Press to translate the input text")

with col_output:
    st.subheader("Output")
    translated_output_area = st.empty()

# ---------- Perform translation ----------
if translate_btn:
    if not input_text or input_text.strip() == "":
        st.warning("Please enter some text to translate.")
    else:
        try:
            # get target code from name
            target_code = lang_array.get(target_lang)
            if not target_code:
                st.error("Selected target language not found in mapping.")
            else:
                with st.spinner("Translating..."):
                    translated_text = translate(input_text, target_code)
                # show translated text
                translated_output_area.text_area("Translated Text", translated_text, height=220)

                # Download translated text as .txt
                download_name = f"translation_{target_code}.txt"
                st.download_button(
                    label=" Download Translation",
                    data=translated_text,
                    file_name=download_name,
                    mime="text/plain",
                )

                # Speech (if available and enabled)
                if show_audio_option and target_code in speech_langs:
                    try:
                        with st.spinner("Generating audio..."):
                            # use a temporary file for audio
                            with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmpf:
                                tts = gTTS(text=translated_text, lang=target_code, slow=False)
                                tts.write_to_fp(tmpf)
                                tmpf_path = tmpf.name

                        # play audio
                        audio_file = open(tmpf_path, "rb")
                        audio_bytes = audio_file.read()
                        st.audio(audio_bytes, format="audio/mp3")

                        # download button for audio
                        st.download_button(
                            label=" Download Audio (MP3)",
                            data=audio_bytes,
                            file_name=f"translation_audio_{target_code}.mp3",
                            mime="audio/mpeg",
                        )
                        # cleanup temp file
                        try:
                            os.remove(tmpf_path)
                        except Exception:
                            pass
                    except Exception as e:
                        st.error(f"Audio generation failed: {e}")
        except Exception as ex:
            st.error(f"Translation failed: {ex}")

# ---------- Footer ----------
st.markdown("---")
st.markdown(
    "Uses `mtranslate` for translation and `gTTS` for text-to-speech. "
    "Update `LANG_CSV_PATH` at the top of the script if the language CSV is stored elsewhere."
)
